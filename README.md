# API для бронирования товаров

REST API на основе FastAPI для управления бронированием товаров с интеграцией базы данных PostgreSQL.

## Обзор

Этот проект предоставляет API для управления бронированием товаров. Пользователи могут бронировать товары, если имеется достаточное количество на складе. Система автоматически обновляет информацию о наличии товаров при создании бронирования.

## Особенности

- Контрольные точки RESTful API для управления бронированием товаров
- Отслеживание запасов в реальном времени
- Асинхронные операции с базой данных с использованием SQLAlchemy и asyncpg
- Поддержка Docker и Docker Compose для удобного развертывания
- Комплексный набор тестов с отчетом о покрытии
- Промежуточное программное обеспечение для ведения журнала запросов
- Проверки работоспособности базы данных

## Технологический стек

- Python 3.12
- FastAPI - современный быстрый веб-фреймворк для Python
- SQLAlchemy 2.0 - инструментарий SQL и объектно-реляционное отображение
- PostgreSQL - реляционная база данных с открытым исходным кодом
- asyncpg - драйвер PostgreSQL для asyncio
- uvicorn - сервер ASGI
- Pytest - фреймворк для тестирования
- Docker & Docker Compose - контейнеризация и оркестровка

## Установка

### Предварительные требования

- Docker и Docker Compose

### Настройка

1. Клонируйте репозиторий:
   ```bash
   git clone <ссылка-на-репозиторий>
   cd <название-репозитория>
   ```

2. Создайте файл `.env` на основе `example.env`:
   ```bash
   cp example.env .env
   ```

3. При необходимости отредактируйте `.env` файл и установите свои значения для:
   - `POSTGRES_USER` - пользователь PostgreSQL
   - `POSTGRES_PASSWORD` - пароль PostgreSQL
   - `POSTGRES_DB` - название основной базы данных
   - `POSTGRES_TEST_DB` - название тестовой базы данных

4. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up --build
   ```

Приложение будет доступно по адресу `http://localhost:8000`.

 **Безопасность**: Файл `.env` содержит чувствительные данные и не должен попадать в систему контроля версий. Он уже добавлен в `.gitignore`.

## Контрольные точки API

### Бронирование товара

- **POST** `/reservation/reserve`
- Забронировать товар, если имеется достаточный запас
- Тело запроса:
  ```json
  {
    "product_id": 1,
    "quantity": 5,
    "timestamp": "2023-01-01T00:00:00"
  }
  ```
- Ответ:
  ```json
  {
    "status": "success",
    "message": "Reservation completed successfully.",
    "reservation_id": 1
  }
  ```

### Получить статус бронирования

- **GET** `/reservation/{reservation_id}`
- Получить статус конкретного бронирования
- Ответ:
  ```json
  {
    "status": "completed"
  }
  ```

### Заполнить базу данных тестовыми данными

- **POST** `/reservation/seed-data`
- Заполняет базу данных тестовыми продуктами и резервациями через SQLAlchemy
- Ответ:
  ```json
  {
    "message": "База данных успешно заполнена тестовыми данными",
    "products_added": 6,
    "reservations_added": 5
  }
  ```
-  **Примечание**: Работает только если база данных пуста. При повторном вызове вернет ошибку.

## Модели базы данных

### Модель товаров
- `product_id`: Первичный ключ
- `product_name`: Уникальный идентификатор товара
- `available_quantity`: Текущее доступное количество

### Модель бронирований
- `reservation_id`: Первичный ключ
- `product_id`: Внешний ключ к таблице товаров
- `quantity`: Количество забронированных единиц
- `status`: Статус бронирования (ожидание, выполнено, не выполнено)
- `timestamp`: Временная метка создания

## Тестирование

Для запуска тестов вручную:
```bash
pytest --asyncio-mode=auto --cov=app --cov-report=term --cov-report=xml:/coverage/coverage.xml
```

Тесты автоматически запускаются в настройках Docker Compose перед запуском приложения.

## Структура проекта

```
.
├── app/
│   ├── db.py           # Конфигурация базы данных
│   ├── logger.py       # Конфигурация логирования
│   ├── main.py         # Точка входа в приложение
│   ├── middleware.py   # Определения промежуточного ПО
│   ├── models.py       # Модели базы данных
│   ├── routes.py       # Определения маршрутов API
│   └── schema.py       # Схемы Pydantic
├── tests/              # Файлы тестов
├── Dockerfile          # Конфигурация Docker для приложения
├── Dockerfile.test     # Конфигурация Docker для тестов
├── docker-compose.yml  # Оркестровка нескольких контейнеров
├── init.sql            # Скрипт инициализации базы данных
├── requirements.txt    # Зависимости Python
└── README.md           # Этот файл
```

## Переменные окружения

Приложение использует следующие переменные окружения (настраиваются в файле `.env`):

### База данных
- `DATABASE_URL`: Строка подключения к базе данных PostgreSQL (для локальной разработки)
- `TEST_DATABASE_URL`: Строка подключения к тестовой базе данных (для Docker)
- `POSTGRES_USER`: Имя пользователя PostgreSQL
- `POSTGRES_PASSWORD`: Пароль PostgreSQL 
- `POSTGRES_DB`: Название основной базы данных
- `POSTGRES_TEST_DB`: Название тестовой базы данных

### Приложение
- `APP_ENV`: Окружение приложения (development/production)
- `DEBUG`: Режим отладки (True/False)
- `LOG_LEVEL`: Уровень логирования (INFO, DEBUG, WARNING, ERROR)

### Логирование
- `LOG_FILE_PATH`: Путь к файлу логов (по умолчанию app.log)
- `LOG_MAX_SIZE_BYTES`: Максимальный размер файла лога (по умолчанию 5000000)
- `LOG_BACKUP_COUNT`: Количество резервных копий логов (по умолчанию 2)

**Важно**: 
- Файл `.env` создается на основе `example.env`
- Все секретные данные (пароли, ключи) должны храниться в `.env` и никогда не коммититься в репозиторий

